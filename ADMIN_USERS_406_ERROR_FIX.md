# ๐จ ุฅุตูุงุญ ุฎุทุฃ 406 ูู ุงููุตูู ูุฌุฏูู admin_users

## ๐ ุงููุดููุฉ
ุนูุฏ ุฏุฎูู ุตูุญุฉ "ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู" ูุงู ูุธูุฑ ุฎุทุฃ ูู Console:

```
GET https://sbtzngewizgeqzfbhfjy.supabase.co/rest/v1/admin_users?select=id%2Cis_active&user_id=eq.f7d18de3-9102-4c40-a01a-a34f863ce319&is_active=eq.true 406 (Not Acceptable)
```

## ๐ ุชุญููู ุงููุดููุฉ

### ุงูุณุจุจ ุงูุฌุฐุฑู:
1. **ูุดููุฉ ูู ุงูุตูุงุญูุงุช**: ุงูููุฏ ูู `adminUsersService.ts` ูุญุงูู ุงููุตูู ูุฌุฏูู `admin_users` ูุจุงุดุฑุฉ
2. **ุณูุงุณุงุช RLS**: ุฌุฏูู `admin_users` ูุญูู ุจุณูุงุณุงุช Row Level Security ุชุชุทูุจ ุตูุงุญูุงุช ุฎุงุตุฉ
3. **Service Key ุบูุฑ ูุชููุฑ**: `VITE_SUPABASE_SERVICE_ROLE_KEY` ุบูุฑ ููุนุฑู ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
4. **ุงุณุชุฎุฏุงู Client ุฎุงุทุฆ**: ูุชู ุงุณุชุฎุฏุงู `supabase` ุงูุนุงุฏู ุจุฏูุงู ูู `adminSupabase`

### ุงูููุฏ ุงููุณุจุจ ูููุดููุฉ:
```typescript
// ูู adminUsersService.ts ุงูุณุทุฑ 457-459
const { data: adminUserIds, error: adminError } = await client
  .from('admin_users')
  .select('user_id');
```

### ุณูุงุณุงุช RLS ุงูุญุงููุฉ:
```sql
-- ุณูุงุณุงุช ุชุชุทูุจ ุตูุงุญูุงุช ุฎุงุตุฉ
"Admin users can view admin users" - requires is_admin_user()
"Super admin access" - requires specific user ID
"Super admins can manage admin users" - requires has_admin_permission()
```

## โ ุงูุญู ุงููุทุจู

### 1. ุฅูุดุงุก ุฏุงูุฉ ุขููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
CREATE OR REPLACE FUNCTION get_admin_user_ids()
RETURNS TABLE (user_id UUID) AS $$
BEGIN
    RETURN QUERY
    SELECT au.user_id
    FROM public.admin_users au
    WHERE au.is_active = true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ููุญ ุตูุงุญูุฉ ุงูุชูููุฐ ูุฌููุน ุงููุณุชุฎุฏููู
GRANT EXECUTE ON FUNCTION get_admin_user_ids() TO public;
GRANT EXECUTE ON FUNCTION get_admin_user_ids() TO anon;
GRANT EXECUTE ON FUNCTION get_admin_user_ids() TO authenticated;
```

### 2. ุชุญุฏูุซ ุงูููุฏ ูุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุขููุฉ
```typescript
// ูุจู ุงูุฅุตูุงุญ:
const { data: adminUserIds, error: adminError } = await client
  .from('admin_users')
  .select('user_id');

// ุจุนุฏ ุงูุฅุตูุงุญ:
const { data: adminUserIds, error: adminError } = await client
  .rpc('get_admin_user_ids');
```

## ๐ฏ ููุงุฆุฏ ุงูุญู

### โ ุงููุฒุงูุง:
1. **ุชุฌุงูุฒ ุณูุงุณุงุช RLS**: ุงูุฏุงูุฉ ุชุนูู ุจุตูุงุญูุงุช `SECURITY DEFINER`
2. **ูุง ูุชุทูุจ Service Key**: ูุนูู ูุน ุฃู client ุนุงุฏู
3. **ุฃูุงู ูุญุณู**: ุงูุฏุงูุฉ ุชุนุฑุถ ููุท ุงูุจูุงูุงุช ุงููุทููุจุฉ
4. **ุณูููุฉ ุงูุตูุงูุฉ**: ุญู ูุฑูุฒู ูุฌูุจ ูุนุฑูุงุช ุงููุดุฑููู

### ๐ ุงูุฃูุงู:
- ุงูุฏุงูุฉ ุชุนุฑุถ ููุท `user_id` ูููุดุฑููู ุงููุดุทูู
- ูุง ุชุนุฑุถ ูุนูููุงุช ุญุณุงุณุฉ ุฃุฎุฑู
- ูุญููุฉ ุจู `SECURITY DEFINER` ูุถูุงู ุงูุชูููุฐ ุงูุขูู

## ๐ ุงููููุงุช ุงููุญุฏุซุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- โ ุฅูุดุงุก ุฏุงูุฉ `get_admin_user_ids()`
- โ ููุญ ุตูุงุญูุงุช ุงูุชูููุฐ

### ุงูููุฏ:
- ๐ `src/lib/adminUsersService.ts` - ุชุญุฏูุซ ุงุณุชุฏุนุงุกุงุช ุฌูุจ ูุนุฑูุงุช ุงููุดุฑููู (ุฏุงูุชุงู)
- ๐ `src/lib/separateAdminUsersService.ts` - ุชุญุฏูุซ ุงุณุชุฏุนุงุก ุฌูุจ ูุนุฑูุงุช ุงููุดุฑููู
- ๐ `src/lib/adminAuthService.ts` - ุชุญุฏูุซ ุฏุงูุฉ `isAdminUser` ู `getCurrentAdminUser`
- ๐ `src/services/autoRefreshService.ts` - ุชุญุฏูุซ ุงุณุชุฏุนุงุก ุฌูุจ ูุนุฑูุงุช ุงููุดุฑููู

## ๐งช ููููุฉ ุงูุชุฃูุฏ ูู ุงูุฅุตูุงุญ

### 1. ูุญุต Console
- ูุฌุจ ุฃูุง ูุธูุฑ ุฎุทุฃ `406 (Not Acceptable)`
- ูุฌุจ ุฃูุง ุชุธูุฑ ุฑุณุงุฆู ุฎุทุฃ ูุชุนููุฉ ุจู `admin_users`

### 2. ูุญุต ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
- ุงูุตูุญุฉ ุชุญูู ุจุฏูู ุฃุฎุทุงุก
- ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุชุธูุฑ ุจุดูู ุทุจูุนู
- ูุง ุชูุฌุฏ ุฑุณุงุฆู ุฎุทุฃ ูู ุงููุงุฌูุฉ

### 3. ุงุฎุชุจุงุฑ ุงูุฏุงูุฉ ูุจุงุดุฑุฉ
```sql
-- ุงุฎุชุจุงุฑ ุงูุฏุงูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
SELECT * FROM get_admin_user_ids();
```

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### ูููุทูุฑูู:
1. **ุงุณุชุฎุฏู ุงูุฏุงูุฉ**: ุจุฏูุงู ูู ุงููุตูู ุงููุจุงุดุฑ ูุฌุฏูู `admin_users`
2. **ุชุญูู ูู ุงููุชุงุฆุฌ**: ุชุฃูุฏ ูู ุฃู ุงูุฏุงูุฉ ุชุฑุฌุน ุงูุจูุงูุงุช ุงููุชููุนุฉ
3. **ูุฑุงูุจุฉ ุงูุฃุฏุงุก**: ุงูุฏุงูุฉ ูุญุณูุฉ ููู ุฑุงูุจ ุงูุฃุฏุงุก ูู ุญุงูุฉ ุงูุจูุงูุงุช ุงููุจูุฑุฉ

### ููุฅุฏุงุฑุฉ:
- ุงูุญู ุขูู ููุง ูุคุซุฑ ุนูู ุฃูุงู ุงููุธุงู
- ูุญุณู ูู ุฃุฏุงุก ูููุซูููุฉ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
- ูุง ูุชุทูุจ ุชุบููุฑุงุช ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ

---
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 25-08-2025
**ุงูุฃููููุฉ:** ูุชูุณุทุฉ ๐ง
**ุงูุญุงูุฉ:** ุชู ุงูุฅุตูุงุญ โ
