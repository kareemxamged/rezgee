# ุฅุตูุงุญ ูุดููุฉ ุงูููุงูุจ ุงูููุฑุฑุฉ

## ๐ **ุงููุดููุฉ:**

```
โ ุฎุทุฃ ูู ุฌูุจ ูุงูุจ ุงูุฅูููู: {code: 'PGRST116', details: 'Results contain 3 rows, application/vnd.pgrst.object+json requires 1 row', hint: null, message: 'JSON object requested, multiple (or no) rows returned'}
```

## ๐ **ุงูุณุจุจ:**

### **1. ููุงูุจ ููุฑุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
- ููุฌุฏ ุนุฏุฉ ููุงูุจ ุจููุณ ุงูุงุณู `report_received_notification`
- ุฏุงูุฉ `getEmailTemplate` ุชุณุชุฎุฏู `.maybeSingle()` ุงูุชู ุชุชููุน ุตู ูุงุญุฏ ููุท
- ูุฌูุฏ ุนุฏุฉ ุตููู ูุณุจุจ ุฎุทุฃ `PGRST116`

### **2. ุนุฏู ูุฌูุฏ ุชุฑุชูุจ ูููุชุงุฆุฌ:**
- ูุง ููุฌุฏ ุชุฑุชูุจ ูุญุฏุฏ ููููุงูุจ ุนูุฏ ุฌูุจูุง
- ูุฏ ูุชู ุฌูุจ ูุงูุจ ูุฏูู ุจุฏูุงู ูู ุงูุฃุญุฏุซ

## โ **ุงูุญู ุงูููุทุจู:**

### **1. ุชุญุณูู ุงุณุชุนูุงู ุฌูุจ ุงููุงูุจ:**
```typescript
// ูุจู ุงูุฅุตูุงุญ
const { data, error } = await supabase
  .from('email_templates')
  .select('*')
  .eq('name', templateName)
  .eq('is_active', true)
  .maybeSingle();

// ุจุนุฏ ุงูุฅุตูุงุญ
const { data, error } = await supabase
  .from('email_templates')
  .select('*')
  .eq('name', templateName)
  .eq('is_active', true)
  .order('created_at', { ascending: false })  // ุชุฑุชูุจ ุญุณุจ ุงูุฃุญุฏุซ
  .limit(1)                                   // ุชุญุฏูุฏ ุตู ูุงุญุฏ ููุท
  .maybeSingle();
```

### **2. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
```typescript
if (!data) {
  console.warn(`โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงูุจ ุงูุฅูููู: ${templateName}`);
  return null;
}
```

### **3. ุฑุณุงุฆู ุฎุทุฃ ุฃูุซุฑ ูุถูุญุงู:**
```typescript
throw new Error(`ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุงูุจ ุงููุดุท: ${templateName}. ุชุฃูุฏ ูู ูุฌูุฏ ุงููุงูุจ ูุฃูู ููุนู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.`);
```

### **4. ุงุณุชุนูุงู ูุญุฐู ุงูููุงูุจ ุงูููุฑุฑุฉ:**
```sql
-- ุญุฐู ุงูููุงูุจ ุงูููุฑุฑุฉ (ูุจูู ุนูู ุฃุญุฏุซูุง)
WITH duplicate_templates AS (
    SELECT 
        id,
        name,
        ROW_NUMBER() OVER (
            PARTITION BY name 
            ORDER BY created_at DESC, id DESC
        ) as rn
    FROM email_templates
)
DELETE FROM email_templates 
WHERE id IN (
    SELECT id 
    FROM duplicate_templates 
    WHERE rn > 1
);
```

## ๐ง **ุงูุชูุงุตูู ุงูุชูููุฉ:**

### **1. ุชุฑุชูุจ ุงููุชุงุฆุฌ:**
- `ORDER BY created_at DESC`: ุชุฑุชูุจ ุญุณุจ ุชุงุฑูุฎ ุงูุฅูุดุงุก (ุงูุฃุญุฏุซ ุฃููุงู)
- `LIMIT 1`: ุชุญุฏูุฏ ุตู ูุงุญุฏ ููุท
- `maybeSingle()`: ูุนูู ุจุดูู ุตุญูุญ ูุน ุตู ูุงุญุฏ ุฃู ุตูุฑ

### **2. ูุนุงูุฌุฉ ุงูููุฑุฑุงุช:**
- ุงุณุชุฎุฏุงู `ROW_NUMBER()` ูุชุญุฏูุฏ ุงูููุฑุฑุงุช
- `PARTITION BY name`: ุชุฌููุน ุญุณุจ ุงุณู ุงููุงูุจ
- `ORDER BY created_at DESC, id DESC`: ุชุฑุชูุจ ููุญุตูู ุนูู ุงูุฃุญุฏุซ

### **3. ุงูุฃูุงู:**
- ุงุณุชุฎุฏุงู `BEGIN` ู `COMMIT` ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช
- ุนุฑุถ ุงููุชุงุฆุฌ ูุจู ูุจุนุฏ ุงูุญุฐู ููุชุญูู

## ๐ **ุงููููุงุช ุงูููุญุฏุซุฉ:**

### **1. `src/lib/databaseEmailService.ts`:**
- โ ุฅุถุงูุฉ ุชุฑุชูุจ ููุงุณุชุนูุงู
- โ ุฅุถุงูุฉ `LIMIT 1`
- โ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- โ ุฑุณุงุฆู ุฎุทุฃ ุฃูุซุฑ ูุถูุญุงู

### **2. `fix_duplicate_templates.sql`:**
- โ ุงุณุชุนูุงู ูุญุฐู ุงูููุงูุจ ุงูููุฑุฑุฉ
- โ ุนุฑุถ ุงููุชุงุฆุฌ ูุจู ูุจุนุฏ ุงูุญุฐู
- โ ุฅุญุตุงุฆูุงุช ููุตูุฉ

## ๐ **ููููุฉ ุงูุงุณุชุฎุฏุงู:**

### **ุงูุทุฑููุฉ 1: ุชุดุบูู ุงูุงุณุชุนูุงู (ููุตู ุจู):**
```sql
-- ุชุดุบูู ุงูููู ูุญุฐู ุงูููุฑุฑุงุช
\i fix_duplicate_templates.sql
```

### **ุงูุทุฑููุฉ 2: ุงูุชุญูู ูู ุงูููุฑุฑุงุช:**
```sql
-- ุนุฑุถ ุงูููุงูุจ ุงูููุฑุฑุฉ
SELECT 
    name,
    COUNT(*) as count,
    MIN(created_at) as oldest,
    MAX(created_at) as newest
FROM email_templates 
GROUP BY name 
HAVING COUNT(*) > 1
ORDER BY count DESC;
```

## ๐ **ุงูุชุญูู ูู ุงููุชุงุฆุฌ:**

### **ุจุนุฏ ุชุดุบูู ุงูุงุณุชุนูุงู:**
```sql
-- ูุฌุจ ุฃู ุชุฑู:
-- โ ูุง ุชูุฌุฏ ููุงูุจ ููุฑุฑุฉ
-- โ ูู ูุงูุจ ูู ุตู ูุงุญุฏ ููุท
-- โ ุฅุฌูุงูู ุงูููุงูุจ ูุญุฏุซ
```

### **ุงุฎุชุจุงุฑ ุงููุธุงู:**
1. โ ุงูุถุบุท ุนูู ุฒุฑ ุงุฎุชุจุงุฑ ุงููุงูุจ
2. โ ุนุฏู ุธููุฑ ุฎุทุฃ `PGRST116`
3. โ ุฌูุจ ุงููุงูุจ ุจูุฌุงุญ
4. โ ุฅุฑุณุงู ุงูุฅูููู ุจูุฌุงุญ

## โ๏ธ **ููุงุญุธุงุช ูููุฉ:**

### **1. ุงููุณุฎ ุงูุงุญุชูุงุทู:**
- โ ุชุฃูุฏ ูู ุนูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุญุฐู ุงูููุฑุฑุงุช
- โ ุงูุงุณุชุนูุงู ุขูู ููุจูู ุนูู ุฃุญุฏุซ ุงูููุงูุจ

### **2. ุงููุฑุงูุจุฉ:**
- โ ุฑุงูุจ ุงูุณุฌูุงุช ุจุนุฏ ุงูุชุทุจูู
- โ ุชุฃูุฏ ูู ุนูู ุฌููุน ุงูููุงูุจ ุจุดูู ุตุญูุญ

### **3. ุงูููุงูุฉ:**
- โ ุชุฌูุจ ุฅูุดุงุก ููุงูุจ ููุฑุฑุฉ ูู ุงููุณุชูุจู
- โ ุงุณุชุฎุฏู ุฃุณูุงุก ูุฑูุฏุฉ ููููุงูุจ ุงูุฌุฏูุฏุฉ

## ๐ฏ **ุงูุฎูุงุตุฉ:**

ุชู ุฅุตูุงุญ ูุดููุฉ ุงูููุงูุจ ุงูููุฑุฑุฉ ุจูุฌุงุญ ูู ุฎูุงู:

1. **ุชุญุณูู ุงุณุชุนูุงู ุฌูุจ ุงููุงูุจ** ูุน ุชุฑุชูุจ ูุชุญุฏูุฏ ุตู ูุงุญุฏ
2. **ุฅูุดุงุก ุงุณุชุนูุงู ูุญุฐู ุงูููุฑุฑุงุช** ูุน ุงูุญูุงุธ ุนูู ุฃุญุฏุซ ุงูููุงูุจ
3. **ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ูุน ุฑุณุงุฆู ุฃูุซุฑ ูุถูุญุงู
4. **ุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช** ูุน ุงุณุชุฎุฏุงู ุงููุนุงููุงุช

ุงูุขู ูุฌุจ ุฃู ูุนูู ุงุฎุชุจุงุฑ ุงูููุงูุจ ุจุฏูู ุฃุฎุทุงุกุ ูุณูุชู ุฌูุจ ุฃุญุฏุซ ูุงูุจ ููู ุงุณู ุจุดูู ุตุญูุญ.





