# ุฅุตูุงุญ ูุดุงูู ูุธุงู ุงูุชูุซูู - ุฏููู ุดุงูู

## ๐ ููุฎุต ุงููุดุงูู ูุงูุญููู

### ุงููุดููุฉ ุงูุฃููู: ุนุฏู ุธููุฑ ุงูุตูุฑ ูู ูุงูุฐุฉ ุนุฑุถ ุงูุชูุงุตูู
**ุงููุตู:** ุงูุตูุฑ ุงููุฑููุนุฉ ูู ุงููุณุชุฎุฏููู (ุงููุณุชูุฏุงุช ูุงูุณูููู) ูุง ุชุธูุฑ ูู ูุงูุฐุฉ "ุนุฑุถ ุงูุชูุงุตูู" ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ.

**ุงูุณุจุจ:**
- ูุดููุฉ ูู ุตูุงุญูุงุช ุงูุชุฎุฒูู (Storage Policies)
- ุนุฏู ุชุญููู ูุณุงุฑุงุช ุงูุตูุฑ ุฅูู URLs ุนุงูุฉ ูุงุจูุฉ ููุนุฑุถ
- bucket ุงูุชูุซูู ูู ููู ุนุงู

**ุงูุญู:**
โ ุชุญุฏูุซ ุณูุงุณุงุช ุงูุชุฎุฒูู ููุณูุงุญ ููุฅุฏุงุฑููู ุจุนุฑุถ ุฌููุน ุงูุตูุฑ
โ ุฌุนู bucket ุงูุชูุซูู ุนุงู ูุน ุงูุญูุงุธ ุนูู ุงูุฃูุงู
โ ุฅุถุงูุฉ ุฏุงูุฉ `getPublicImageUrl` ูุชุญููู ูุณุงุฑุงุช ุงูุตูุฑ
โ ุชุญุฏูุซ ุฏุงูุฉ `getAllRequests` ููุนุงูุฌุฉ URLs ุงูุตูุฑ

### ุงููุดููุฉ ุงูุซุงููุฉ: ุฎุทุฃ RLS ูู verification_history
**ุงููุตู:** ุนูุฏ ุงูุถุบุท ุนูู "ุฅุฑุณุงู ุงูุทูุจ" ูู ุงููุฑุญูุฉ ุงูุฃุฎูุฑุฉุ ูุธูุฑ ุฎุทุฃ:
```
new row violates row-level security policy for table "verification_history"
```

**ุงูุณุจุจ:**
- trigger ูุญุงูู ุฅุฏุฑุงุฌ ุณุฌู ูู `verification_history` ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ
- ุงููุณุชุฎุฏู ุงูุนุงุฏู ูุง ูููู ุตูุงุญูุฉ ุงูุฅุฏุฑุงุฌ ูู ุฌุฏูู ุงูุชุงุฑูุฎ
- ุฏูุงู trigger ูุง ุชููู ุตูุงุญูุงุช ูุงููุฉ ูุชุฌุงูุฒ RLS

**ุงูุญู:**
โ ุฅุถุงูุฉ `SECURITY DEFINER` ูุฏูุงู trigger ูุชุฌุงูุฒ RLS
โ ุฅูุดุงุก ุณูุงุณุฉ ุนุงูุฉ ูููุธุงู ููุฅุฏุฑุงุฌ ูู `verification_history`
โ ุชุญุฏูุซ ุณูุงุณุงุช RLS ููุณูุงุญ ุจุชุญุฏูุซ ุงูุทูุจุงุช ุนูุฏ ุชุบููุฑ ุงูุญุงูุฉ
โ ุฅุตูุงุญ ุฏูุงู trigger ูุฅุนุงุฏุฉ ุฅูุดุงุฆูุง

## ๐ง ุงููููุงุช ุงููุญุฏุซุฉ

### 1. ูููุงุช SQL:
- `FINAL_VERIFICATION_FIXES.sql` - ููู ุดุงูู ูุฌููุน ุงูุฅุตูุงุญุงุช
- `apply-verification-fixes.sql` - ุฅุตูุงุญุงุช RLS ูุงูู triggers
- `fix-verification-storage-policies.sql` - ุฅุตูุงุญุงุช ุงูุชุฎุฒูู
- `fix-verification-trigger.sql` - ุฅุตูุงุญุงุช ุฏูุงู trigger

### 2. ูููุงุช ุงูููุฏ:
- `src/lib/verificationService.ts` - ุฅุถุงูุฉ ุฏุงูุฉ ูุนุงูุฌุฉ URLs ุงูุตูุฑ

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### ุงูุฎุทูุฉ 1: ุชุทุจูู ุฅุตูุงุญุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
-- ูู Supabase SQL Editor ุฃู psql
\i FINAL_VERIFICATION_FIXES.sql
```

ุฃู ููููู ุชุทุจูู ุงูููู ุนุจุฑ Supabase Dashboard:
1. ุงุฐูุจ ุฅูู SQL Editor ูู Supabase Dashboard
2. ุงูุณุฎ ูุญุชูู ููู `FINAL_VERIFICATION_FIXES.sql`
3. ุงูุตู ุงููุญุชูู ูุดุบู ุงูุงุณุชุนูุงู

### ุงูุฎุทูุฉ 2: ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
```bash
npm run dev
```

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช
1. **ุงุฎุชุจุงุฑ ุนุฑุถ ุงูุตูุฑ:**
   - ุงุฐูุจ ุฅูู ููุญุฉ ุงูุฅุฏุงุฑุฉ > ุงููุณุชุฎุฏููู > ุทูุจุงุช ุงูุชูุซูู
   - ุงุถุบุท ุนูู "ุนุฑุถ ุงูุชูุงุตูู" ูุฃู ุทูุจ ุชูุซูู
   - ุชุฃูุฏ ูู ุธููุฑ ุงูุตูุฑ (ุงููุณุชูุฏ ุงูุฃูุงููุ ุงูุฎูููุ ุงูุณูููู)

2. **ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุทูุจ ุงูุชูุซูู:**
   - ุณุฌู ุฏุฎูู ููุณุชุฎุฏู ุนุงุฏู
   - ุฃูุดุฆ ุทูุจ ุชูุซูู ุฌุฏูุฏ
   - ุฃููู ุฌููุน ุงููุฑุงุญู ุญุชู ุงููุฑุญูุฉ ุงูุฃุฎูุฑุฉ
   - ุงุถุบุท ุนูู "ุฅุฑุณุงู ุงูุทูุจ"
   - ุชุฃูุฏ ูู ุนุฏู ุธููุฑ ุฎุทุฃ RLS

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### ุณูุงุณุงุช RLS ุงููุญุฏุซุฉ:

#### ูููุณุชุฎุฏููู ุงูุนุงุฏููู:
```sql
-- ุนุฑุถ ุทูุจุงุชูู ุงูุฎุงุตุฉ ููุท
CREATE POLICY "Users can view their own verification requests" 
ON verification_requests FOR SELECT USING (auth.uid() = user_id);

-- ุชุญุฏูุซ ุทูุจุงุชูู ุนูุฏูุง ุชููู pending ูุชุบููุฑูุง ุฅูู under_review
CREATE POLICY "Users can update their own pending verification requests" 
ON verification_requests FOR UPDATE 
USING (auth.uid() = user_id AND status = 'pending') 
WITH CHECK (auth.uid() = user_id AND status IN ('pending', 'under_review'));
```

#### ููุฅุฏุงุฑููู:
```sql
-- ุนุฑุถ ุฌููุน ุงูุทูุจุงุช
CREATE POLICY "Admins can view all verification requests" 
ON verification_requests FOR SELECT USING (
    EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid() AND is_active = true)
);
```

### ุฏูุงู Trigger ุงููุญุฏุซุฉ:
```sql
-- ุฏุงูุฉ ูุน SECURITY DEFINER ูุชุฌุงูุฒ RLS
CREATE OR REPLACE FUNCTION log_verification_status_change()
RETURNS TRIGGER SECURITY DEFINER AS $$
BEGIN
    -- ุชุณุฌูู ุชุบููุฑ ุงูุญุงูุฉ ูู ุฌุฏูู ุงูุชุงุฑูุฎ
    IF OLD.status IS DISTINCT FROM NEW.status THEN
        INSERT INTO verification_history (...) VALUES (...);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### ุณูุงุณุงุช ุงูุชุฎุฒูู:
```sql
-- ุงูุณูุงุญ ููุฅุฏุงุฑููู ุจุนุฑุถ ุฌููุน ุงูุตูุฑ
CREATE POLICY "Admins can view all verification images" ON storage.objects
FOR SELECT USING (
    bucket_id = 'verification-documents' 
    AND EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid())
);
```

## ๐ก๏ธ ุงูุฃูุงู

### ูุง ุชู ุงูุญูุงุธ ุนููู:
- ุงููุณุชุฎุฏููู ูููููู ููุท ุฑูุน ูุนุฑุถ ุตูุฑูู ุงูุฎุงุตุฉ
- ุงูุฅุฏุงุฑููู ููุท ูููููู ุนุฑุถ ุฌููุน ุงูุตูุฑ
- ุณูุงุณุงุช RLS ุชููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู
- ุงูุชุฎุฒูู ูุญูู ุจุณูุงุณุงุช ุตุงุฑูุฉ

### ูุง ุชู ุชุญุณููู:
- bucket ุงูุชูุซูู ุฃุตุจุญ ุนุงู ูุนุฑุถ ุงูุตูุฑ ูุน ุงูุญูุงุธ ุนูู ุงูุฃูุงู
- ุฏูุงู trigger ุชุนูู ุจุตูุงุญูุงุช ุงููุธุงู ูุชุฌุงูุฒ RLS ุนูุฏ ุงูุญุงุฌุฉ
- ูุนุงูุฌุฉ ุฃูุถู ูู URLs ุงูุตูุฑ

## ๐งช ุงุฎุชุจุงุฑุงุช ุดุงููุฉ

### ุณููุงุฑูู 1: ูุณุชุฎุฏู ุนุงุฏู
1. โ ุชุณุฌูู ุฏุฎูู ููุณุชุฎุฏู ุนุงุฏู
2. โ ุฅูุดุงุก ุทูุจ ุชูุซูู ุฌุฏูุฏ
3. โ ุฅููุงู ุงููุฑุญูุฉ 1 (ุงููุนูููุงุช ุงูุดุฎุตูุฉ)
4. โ ุฅููุงู ุงููุฑุญูุฉ 2 (ููุน ุงููุณุชูุฏ)
5. โ ุฅููุงู ุงููุฑุญูุฉ 3 (ุชูุงุตูู ุงููุณุชูุฏ)
6. โ ุฅููุงู ุงููุฑุญูุฉ 4 (ุฑูุน ุตูุฑ ุงููุณุชูุฏ)
7. โ ุฅููุงู ุงููุฑุญูุฉ 5 (ุฑูุน ุงูุณูููู ูุฅุฑุณุงู ุงูุทูุจ)
8. โ ุงูุชุฃูุฏ ูู ุนุฏู ุธููุฑ ุฃุฎุทุงุก RLS

### ุณููุงุฑูู 2: ุฅุฏุงุฑู
1. โ ุชุณุฌูู ุฏุฎูู ูุฅุฏุงุฑู
2. โ ุงูุงูุชูุงู ุฅูู ููุญุฉ ุงูุฅุฏุงุฑุฉ > ุงููุณุชุฎุฏููู > ุทูุจุงุช ุงูุชูุซูู
3. โ ุนุฑุถ ูุงุฆูุฉ ุทูุจุงุช ุงูุชูุซูู
4. โ ูุชุญ "ุนุฑุถ ุงูุชูุงุตูู" ูุทูุจ ุชูุซูู
5. โ ุงูุชุฃูุฏ ูู ุธููุฑ ุฌููุน ุงูุตูุฑ (ุฃูุงููุ ุฎูููุ ุณูููู)
6. โ ุงูููุงููุฉ ุฃู ุฑูุถ ุงูุทูุจ
7. โ ุงูุชุฃูุฏ ูู ุชุณุฌูู ุงูุชุบููุฑ ูู ุงูุชุงุฑูุฎ

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ูู ุชุธูุฑ ุงูุตูุฑ:
1. ุชุญูู ูู ุชุทุจูู ููู `FINAL_VERIFICATION_FIXES.sql`
2. ุชุฃูุฏ ูู ุฃู bucket `verification-documents` ููุฌูุฏ ูุนุงู
3. ูุญุต console ุงููุชุตูุญ ููุฃุฎุทุงุก
4. ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ูู `admin_users`

### ุฅุฐุง ุงุณุชูุฑ ุฎุทุฃ RLS:
1. ุชุฃูุฏ ูู ุชุทุจูู ุฏูุงู trigger ุงูุฌุฏูุฏุฉ
2. ุชุญูู ูู ูุฌูุฏ ุณูุงุณุฉ `System can insert verification history`
3. ูุญุต logs ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชูุงุตูู
4. ุชุฃูุฏ ูู ุชูุนูู RLS ุนูู ุงูุฌุฏุงูู

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู logs ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ูุญุต console ุงููุชุตูุญ
3. ุชุฃูุฏ ูู ุชุทุจูู ุฌููุน ุงูุฅุตูุงุญุงุช
4. ุฑุงุฌุน ูุฐุง ุงูุฏููู ููุชุฃูุฏ ูู ุงูุฎุทูุงุช

---

**ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:** 21-08-2025  
**ุญุงูุฉ ุงูุฅุตูุงุญุงุช:** โ ููุชููุฉ ููุฎุชุจุฑุฉ
