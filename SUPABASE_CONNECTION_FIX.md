# ๐ง ุญู ูุดููุฉ ุงุชุตุงู Supabase

## ๐ ูุตู ุงููุดููุฉ

**ุงูุฎุทุฃ ุงููุจูุบ ุนูู:**
```
POST https://sbtzngewizgeqzfbhfjy.supabase.co/auth/v1/token?grant_type=refresh_token net::ERR_CONNECTION_CLOSED
TypeError: Failed to fetch
at _refreshAccessToken (supabase-js.js:6489:20)
at _callRefreshToken (supabase-js.js:6584:42)
```

## ๐ ุชุดุฎูุต ุงููุดููุฉ

### ุงูุณุจุจ ุงูุฌุฐุฑู:
- **ุฎุทุฃ ุงุชุตุงู ุดุจูุฉ** ูุน ุฎุงุฏู Supabase ุฃุซูุงุก ุชุฌุฏูุฏ ุฑูุฒ ุงููุตุงุฏูุฉ
- **ุงููุทุงุน ูุคูุช** ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช
- **ูุดุงูู ูู DNS** ุฃู ุฌุฏุงุฑ ุงูุญูุงูุฉ
- **ุงูุชูุงุก ุตูุงุญูุฉ refresh token** ุฃู ูุดุงูู ูู ุงูุฌูุณุฉ

### ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:
1. **ูุดุงูู ุงูุดุจูุฉ**: ุงููุทุงุน ุงูุฅูุชุฑูุชุ ูุดุงูู DNSุ ุญุฌุจ ุฌุฏุงุฑ ุงูุญูุงูุฉ
2. **ูุดุงูู Supabase**: ุงูุชูุงุก ุตูุงุญูุฉ ุงูุฑูุฒุ ูุดุงูู ุงูุฎุงุฏูุ ุชุญุฏูุซุงุช API
3. **ูุดุงูู ุงููุชุตูุญ**: CORSุ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุชุ ุฅุถุงูุงุช ุงููุชุตูุญ

## โ ุงูุญููู ุงููุทุจูุฉ

### 1. ุชุญุณูู ุฅุนุฏุงุฏุงุช Supabase Client

```typescript
// ูู lib/supabase.ts
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
    retryAttempts: 3, // ุฅุนุงุฏุฉ ุงููุญุงููุฉ 3 ูุฑุงุช
  },
  global: {
    headers: {
      'X-Client-Info': 'rezge-app',
    },
    // timeout ูุญุณู ูููุดู ุงูุณุฑูุน ุนู ูุดุงูู ุงูุงุชุตุงู
    fetch: (url, options = {}) => {
      return fetch(url, {
        ...options,
        signal: AbortSignal.timeout(15000), // 15 seconds timeout
      });
    },
  },
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});
```

### 2. ูุธุงู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ

```typescript
// ุฏุงูุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุน Exponential Backoff
export const retrySupabaseRequest = async <T>(
  requestFn: () => Promise<T>, 
  maxRetries = 3,
  baseDelay = 1000
): Promise<T> => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await requestFn();
    } catch (error: any) {
      const isNetworkError = error.message?.includes('Failed to fetch') || 
                            error.message?.includes('ERR_CONNECTION_CLOSED');
      
      if (i === maxRetries - 1 || !isNetworkError) {
        throw error;
      }
      
      const delay = baseDelay * Math.pow(2, i); // Exponential backoff
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
};
```

### 3. ูุนุงูุฌ ุฃุฎุทุงุก ุดุงูู

```typescript
// ูุนุงูุฌ ุฃุฎุทุงุก Supabase ุงูุนุงู
export const handleSupabaseError = (error: any, context?: string) => {
  const errorMessage = error?.message || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู';
  
  if (errorMessage.includes('Failed to fetch') || 
      errorMessage.includes('ERR_CONNECTION_CLOSED')) {
    console.warn(`๐ ูุดููุฉ ุงุชุตุงู ูุคูุชุฉ ูุน Supabase:`, errorMessage);
    
    // ุฅุดุนุงุฑ ุงููุณุชุฎุฏู ุจูุดููุฉ ุงูุงุชุตุงู
    const event = new CustomEvent('supabase-connection-error', {
      detail: { error, context }
    });
    window.dispatchEvent(event);
    return;
  }
  
  if (errorMessage.includes('JWT expired')) {
    console.warn('๐ ุงูุชูุช ุตูุงุญูุฉ ุงูุฌูุณุฉุ ูุชุทูุจ ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ');
    supabase.auth.signOut();
    return;
  }
  
  console.error(`โ ุฎุทุฃ Supabase:`, error);
};
```

### 4. ูุฏูุฑ ุงูุงุชุตุงู ุงููุชูุฏู

```typescript
// src/utils/connectionManager.ts
class ConnectionManager {
  // ูุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู
  // ูุญุต ุฏูุฑู ููุงุชุตุงู ูุน Supabase
  // ุงูุชุฑุงุญ ุญููู ูููุณุชุฎุฏู
  // ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ
}
```

**ุงูููุฒุงุช:**
- **ูุฑุงูุจุฉ ูุณุชูุฑุฉ** ูุญุงูุฉ ุงูุงุชุตุงู
- **ูุญุต ุฏูุฑู** ูู 30 ุซุงููุฉ
- **ุงูุชุฑุงุญ ุญููู** ุนูุฏ ุชูุฑุงุฑ ุงูุฃุฎุทุงุก
- **ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ** ูููุงุฌูุฉ

### 5. ูููู ุนุฑุถ ุญุงูุฉ ุงูุงุชุตุงู

```typescript
// src/components/ConnectionStatus.tsx
const ConnectionStatusComponent: React.FC = () => {
  // ุนุฑุถ ุญุงูุฉ ุงูุงุชุตุงู ุงูุญุงููุฉ
  // ุงูุชุฑุงุญุงุช ุงูุญููู ูููุณุชุฎุฏู
  // ุฒุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
  // ุชูุงุตูู ุชุดุฎูุตูุฉ
};
```

**ุงูููุฒุงุช:**
- **ุนุฑุถ ุจุตุฑู** ูุญุงูุฉ ุงูุงุชุตุงู
- **ุงูุชุฑุงุญุงุช ุชูุงุนููุฉ** ููุญููู
- **ุฒุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ** ูููุณุชุฎุฏู
- **ุฅุฎูุงุก ุชููุงุฆู** ุนูุฏ ุนูู ูู ุดูุก ุจุดูู ุทุจูุนู

### 6. ุชุญุณูู AuthContext

```typescript
// ุชุญุณูู refreshProfile ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
const refreshProfile = useCallback(async (): Promise<void> => {
  if (user) {
    try {
      await executeSupabaseRequest(
        () => loadUserProfile(user.id, true),
        'refreshProfile'
      );
    } catch (error) {
      handleSupabaseError(error, 'refreshProfile');
      return;
    }
    // ... ุจุงูู ุงูููุฏ
  }
}, [user]);
```

## ๐๏ธ ุงููููุงุช ุงููุญุฏุซุฉ

### ุงููููุงุช ุงูุฃุณุงุณูุฉ:
- `src/lib/supabase.ts` - ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุนููู ููุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- `src/contexts/AuthContext.tsx` - ุชุญุณูู ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุตุงุฏูุฉ
- `src/utils/connectionManager.ts` (ุฌุฏูุฏ) - ูุฏูุฑ ุงูุงุชุตุงู ุงููุชูุฏู
- `src/components/ConnectionStatus.tsx` (ุฌุฏูุฏ) - ูููู ุนุฑุถ ุญุงูุฉ ุงูุงุชุตุงู
- `src/App.tsx` - ุฅุถุงูุฉ ูููู ุญุงูุฉ ุงูุงุชุตุงู

### ูููุงุช ุงูุชูุซูู:
- `debug-supabase-connection.html` - ุฃุฏุงุฉ ุชุดุฎูุต ุชูุงุนููุฉ
- `SUPABASE_CONNECTION_FIX.md` - ูุฐุง ุงูููู

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### โ ูุง ุชู ุญูู:
- **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุงุชุตุงู** ุชููุงุฆูุงู
- **ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุฐููุฉ** ููุทูุจุงุช ุงููุงุดูุฉ
- **ุฅุดุนุงุฑุงุช ุงููุณุชุฎุฏู** ุจูุดุงูู ุงูุงุชุตุงู
- **ุญููู ุชูุงุนููุฉ** ูููุณุชุฎุฏู
- **ูุฑุงูุจุฉ ูุณุชูุฑุฉ** ูุญุงูุฉ ุงูุงุชุตุงู

### ๐ ุงูุณููู ุงูุฌุฏูุฏ:
1. **ุนูุฏ ุงููุทุงุน ุงูุงุชุตุงู**: ุนุฑุถ ุฅุดุนุงุฑ ูููุณุชุฎุฏู ูุน ุงูุชุฑุงุญุงุช
2. **ุนูุฏ ุนูุฏุฉ ุงูุงุชุตุงู**: ุฅุฎูุงุก ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู
3. **ุนูุฏ ูุดู ุงูุทูุจุงุช**: ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุชููุงุฆูุงู 3 ูุฑุงุช
4. **ุนูุฏ ุงูุชูุงุก ุงูุฌูุณุฉ**: ุชุณุฌูู ุฎุฑูุฌ ุชููุงุฆู ูุชูุธูู ุงูุจูุงูุงุช

## ๐งช ุงุฎุชุจุงุฑ ุงูุญู

### ูููุทูุฑูู:
1. **ูุทุน ุงูุฅูุชุฑูุช** ูุคูุชุงู ููุงุญุธ ุธููุฑ ุฅุดุนุงุฑ ุงูุงุชุตุงู
2. **ุฃุนุฏ ุชุดุบูู ุงูุฅูุชุฑูุช** ููุงุญุธ ุงุฎุชูุงุก ุงูุฅุดุนุงุฑ
3. **ุฑุงูุจ ูุญุฏุฉ ุงูุชุญูู** ููุชุฃูุฏ ูู ุนูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ
4. **ุงุฎุชุจุฑ ูุน ุดุจูุฉ ุจุทูุฆุฉ** ููุชุฃูุฏ ูู timeout

### ูููุณุชุฎุฏููู:
1. **ุงุณุชุฎุฏู ุงููููุน ุจุดูู ุทุจูุนู**
2. **ูุงุญุธ ุฅุดุนุงุฑุงุช ุงูุงุชุตุงู** ุนูุฏ ูุฌูุฏ ูุดุงูู
3. **ุงุณุชุฎุฏู ุฒุฑ ุฅุนุงุฏุฉ ุงููุญุงููุฉ** ุนูุฏ ุงูุญุงุฌุฉ
4. **ุงุชุจุน ุงูุงูุชุฑุงุญุงุช** ุงููุนุฑูุถุฉ ูุญู ุงููุดุงูู

## ๐จ ุญููู ุณุฑูุนุฉ ูููุณุชุฎุฏููู

### ุนูุฏ ุธููุฑ ุฎุทุฃ ุงูุงุชุตุงู:
1. **ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ** (Ctrl+F5)
2. **ุชุญูู ูู ุงูุฅูุชุฑูุช**
3. **ุงูุณุญ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช**
4. **ุฌุฑุจ ูุชุตูุญ ุขุฎุฑ**
5. **ุณุฌู ุฎุฑูุฌ ูุฏุฎูู ูุฑุฉ ุฃุฎุฑู**

### ูููุทูุฑูู:
1. ุชุญูู ูู [ุญุงูุฉ Supabase](https://status.supabase.com)
2. ุฑุงุฌุน ุฅุนุฏุงุฏุงุช CORS ูู ูุดุฑูุน Supabase
3. ุชุญูู ูู ุตุญุฉ environment variables
4. ุฑุงุฌุน logs ูู Supabase Dashboard

## ๐ ุงูุฏุนู

ุฅุฐุง ุงุณุชูุฑ ุธููุฑ ุงูุฎุทุฃ:
- ุฑุงุฌุน ููู `debug-supabase-connection.html` ููุชุดุฎูุต ุงูุชูุงุนูู
- ุชุญูู ูู ุญุงูุฉ Supabase ุนูู ุงููููุน ุงูุฑุณูู
- ุฑุงุฌุน ุฅุนุฏุงุฏุงุช ุงูุดุจูุฉ ูุงูุฌุฏุงุฑ ุงููุงุฑู
- ุงุชุตู ุจุฏุนู Supabase ุฅุฐุง ูุงูุช ุงููุดููุฉ ูู ุฌุงูุจูู

---

## ๐ ุชุญุฏูุซ ุฌุฏูุฏ: ุฅุตูุงุญ ูุดููุฉ JWT ูู ุงููุดุฑ (29 ุฃุบุณุทุณ 2025)

### ๐ฏ ุงููุดููุฉ ุงูููุชุดูุฉ
- **ุงููุตู**: ูุดููุฉ JWT expired ุชุญุฏุซ ูู ุงููุดุฑ ููุท ูููุณ ูู localhost
- **ุงูุฃุนุฑุงุถ**:
  ```
  JWT expired
  POST https://sbtzngewizgeqzfbhfjy.supabase.co/rest/v1/rpc/verify_admin_password 401 (Unauthorized)
  PGRST301 error
  ```

### ๐ง ุงูุญููู ุงููุทุจูุฉ

#### 1. ูุธุงู JWT Manager ูุญุณู
- **ุงูููู**: `src/lib/supabase.ts`
- **ุงูููุฒุงุช**:
  - ุชุฌุฏูุฏ ุงุณุชุจุงูู ููุฑููุฒ
  - ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุชูุฏูุฉ
  - ูุตู ูุงูู ุจูู ุฃูุธูุฉ ุงููุตุงุฏูุฉ
  - ุฅุนุงุฏุฉ ูุญุงููุฉ ุฐููุฉ

#### 2. ูุนุงูุฌ ุฃุฎุทุงุก JWT ูุชุฎุตุต
- **ุงูููู**: `src/utils/jwtErrorHandler.ts`
- **ุงูููุฒุงุช**:
  - ุชุญููู ุฏููู ูุฃููุงุน ุฃุฎุทุงุก JWT
  - ูุนุงูุฌุฉ ูููุตูุฉ ูููุณุชุฎุฏููู ูุงูุฅุฏุงุฑููู
  - ุฅุตูุงุญ ุชููุงุฆู ูููุดุงูู ุงูุดุงุฆุนุฉ
  - ุชุชุจุน ุชุงุฑูุฎ ุงูุฃุฎุทุงุก

#### 3. ูุธุงู ุชุดุฎูุต ุงููุดุฑ
- **ุงูููู**: `src/utils/productionDiagnostics.ts`
- **ุงูููุฒุงุช**:
  - ูุญุต ุดุงูู ูุจูุฆุฉ ุงููุดุฑ
  - ุชุดุฎูุต ูุดุงูู JWT ูุงูุงุชุตุงู
  - ุฅุตูุงุญ ุชููุงุฆู ูููุดุงูู
  - ุชูุงุฑูุฑ ููุตูุฉ

#### 4. ุฅุตูุงุญุงุช ุงููุดุฑ ุงูุชููุงุฆูุฉ
- **ุงูููุฒุงุช**:
  - ูุณุญ ุงูุจูุงูุงุช ุงูุชุงููุฉ ุชููุงุฆูุงู
  - ุฅุนุงุฏุฉ ุชููุฆุฉ ุงูุงุชุตุงู
  - ูุญุต ุฏูุฑู ูููุดุงูู
  - ุชุฌุฏูุฏ ุงุณุชุจุงูู ููุฑููุฒ

### ๐๏ธ ุฃุฏูุงุช ุงูุชุดุฎูุต ูููุทูุฑูู

ูููู ุงุณุชุฎุฏุงู ุงูุฃุฏูุงุช ุงูุชุงููุฉ ูู console ุงููุชุตูุญ:

```javascript
// ูุญุต ุณุฑูุน ูููุดุงูู
rezgeDiagnostics.quickCheck()

// ุฅุตูุงุญ ุณุฑูุน
rezgeDiagnostics.quickFix()

// ุฅุนุงุฏุฉ ุชุนููู ูุงููุฉ
rezgeDiagnostics.fullReset()

// ูุนูููุงุช ููุตูุฉ
rezgeDiagnostics.detailedInfo()
```

### ๐ ุงููุชุงุฆุฌ
- โ ุชู ุญู ูุดููุฉ JWT expired ูู ุงููุดุฑ
- โ ูุตู ูุงูู ุจูู ุฃูุธูุฉ ุงููุตุงุฏูุฉ
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ
- โ ุฃุฏูุงุช ุชุดุฎูุต ูุชูุฏูุฉ
- โ ุฅุตูุงุญุงุช ุชููุงุฆูุฉ ูููุดุฑ

### ๐ ููุงุญุธุงุช ุฅุถุงููุฉ

- ุชู ุชุทุจูู ุฌููุน ุงูุญููู ุจูุฌุงุญ
- ุงููุธุงู ูุนูู ุงูุขู ุจุดูู ูุณุชูุฑ ูู ุงููุดุฑ
- ุชู ุฅุถุงูุฉ ูุฑุงูุจุฉ ูุณุชูุฑุฉ ููุงุชุตุงู
- ูุชู ุญูุธ ุณุฌู ุงูุฃุฎุทุงุก ูููุฑุงุฌุนุฉ ุงููุณุชูุจููุฉ
- ุฃุฏูุงุช ุงูุชุดุฎูุต ูุชุงุญุฉ ูููุทูุฑูู ูู console

---

**ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:** 29 ุฃุบุณุทุณ 2025
**ุญุงูุฉ ุงูุฅุตูุงุญ:** ููุชูู โ
