# إصلاح مشاكل نظام التوثيق

## المشاكل المحلولة:

### 1. مشكلة عدم ظهور الصور في نافذة عرض التفاصيل
**السبب:** مشكلة في صلاحيات التخزين وعدم تحويل مسارات الصور إلى URLs عامة قابلة للعرض.

**الحل:**
- تحديث سياسات التخزين لجعل bucket التوثيق عام
- إضافة دالة `getPublicImageUrl` لتحويل مسارات الصور إلى URLs عامة
- تحديث دالة `getAllRequests` لمعالجة URLs الصور

### 2. مشكلة خطأ RLS في verification_history
**السبب:** عند إرسال طلب التوثيق، يحاول trigger إدراج سجل في `verification_history` لكن المستخدم العادي لا يملك صلاحية الإدراج.

**الحل:**
- تحديث دوال trigger لاستخدام `SECURITY DEFINER` لتجاوز RLS
- إضافة سياسة عامة للنظام للإدراج في `verification_history`
- تحديث سياسات RLS للسماح بتحديث الطلبات عند تغيير الحالة إلى `under_review`

## الملفات المحدثة:

### 1. `apply-verification-fixes.sql`
ملف SQL شامل يحتوي على جميع إصلاحات سياسات RLS ودوال trigger.

### 2. `fix-verification-storage-policies.sql`
ملف SQL لإصلاح سياسات التخزين وجعل bucket التوثيق عام.

### 3. `src/lib/verificationService.ts`
- إضافة دالة `getPublicImageUrl` لتحويل مسارات الصور
- تحديث دالة `getAllRequests` لمعالجة URLs الصور

## خطوات التطبيق:

### 1. تطبيق إصلاحات قاعدة البيانات:
```sql
-- تطبيق إصلاحات RLS والـ triggers
\i apply-verification-fixes.sql

-- تطبيق إصلاحات التخزين
\i fix-verification-storage-policies.sql
```

### 2. إعادة تشغيل التطبيق:
```bash
npm run dev
```

### 3. اختبار الإصلاحات:
1. **اختبار عرض الصور:**
   - انتقل إلى لوحة الإدارة > المستخدمين > طلبات التوثيق
   - اضغط على "عرض التفاصيل" لأي طلب توثيق
   - تأكد من ظهور الصور (المستند الأمامي، الخلفي، السيلفي)

2. **اختبار إرسال طلب التوثيق:**
   - قم بإنشاء طلب توثيق جديد من حساب مستخدم عادي
   - أكمل جميع المراحل حتى المرحلة الأخيرة
   - اضغط على "إرسال الطلب"
   - تأكد من عدم ظهور خطأ RLS

## ملاحظات مهمة:

### أمان التخزين:
- تم جعل bucket التوثيق عام لعرض الصور، لكن مع الحفاظ على سياسات RLS للتحكم في الوصول
- المستخدمون يمكنهم فقط رفع وعرض صورهم الخاصة
- الإداريون يمكنهم عرض جميع الصور

### سياسات RLS:
- تم إضافة سياسة `SECURITY DEFINER` للدوال لتجاوز RLS عند الحاجة
- المستخدمون يمكنهم تحديث طلباتهم فقط عندما تكون في حالة `pending`
- عند تغيير الحالة إلى `under_review` يتم السماح بالتحديث

### مراقبة الأخطاء:
- تم تحسين معالجة الأخطاء في `verificationService`
- إضافة تسجيل مفصل لتتبع مشاكل التخزين والـ RLS

## في حالة استمرار المشاكل:

### إذا لم تظهر الصور:
1. تحقق من إعدادات bucket في Supabase Dashboard
2. تأكد من أن الصور تم رفعها بنجاح
3. فحص console للأخطاء في تحميل الصور

### إذا استمر خطأ RLS:
1. تحقق من تطبيق ملف `apply-verification-fixes.sql`
2. تأكد من وجود المستخدم في جدول `admin_users` إذا كان إداري
3. فحص logs قاعدة البيانات للأخطاء التفصيلية

## اختبار شامل:

### سيناريو 1: مستخدم عادي
1. تسجيل دخول كمستخدم عادي
2. إنشاء طلب توثيق جديد
3. إكمال جميع المراحل
4. إرسال الطلب النهائي
5. التأكد من عدم ظهور أخطاء

### سيناريو 2: إداري
1. تسجيل دخول كإداري
2. الانتقال إلى لوحة الإدارة
3. عرض طلبات التوثيق
4. فتح تفاصيل طلب توثيق
5. التأكد من ظهور جميع الصور
6. الموافقة أو رفض الطلب
7. التأكد من تسجيل التغيير في التاريخ
