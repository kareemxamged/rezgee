/**
 * Ø³ÙƒØ±ÙŠÙ¾Øª Ù„Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 */

import { createClient } from '@supabase/supabase-js';

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
const supabaseUrl = 'https://sbtznggewizgeqzfbhfjy.supabase.co';
const supabaseServiceKey = 'sbp_017dfdf398fe3ff584eb443aa3aefd7f3d9883b3';

const supabase = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

async function clearTemporaryPasswords() {
  console.log('ðŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©...');
  
  try {
    // Ø£ÙˆÙ„Ø§Ù‹: Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    const { data: allRecords, error: countError } = await supabase
      .from('temporary_passwords')
      .select('*');
    
    if (countError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', countError);
      return;
    }
    
    console.log(`ðŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${allRecords?.length || 0} Ø³Ø¬Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©`);
    
    if (allRecords && allRecords.length > 0) {
      console.log('ðŸ“‹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:');
      allRecords.forEach((record, index) => {
        console.log(`  ${index + 1}. ID: ${record.id}, Email: ${record.email}, Created: ${record.created_at}, Used: ${record.is_used}`);
      });
    }
    
    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const { data: deleteResult, error: deleteError } = await supabase
      .from('temporary_passwords')
      .delete()
      .neq('id', '00000000-0000-0000-0000-000000000000'); // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    
    if (deleteError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', deleteError);
      return;
    }
    
    console.log('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ù†Ø¬Ø§Ø­');
    console.log('ðŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', allRecords?.length || 0);
    
    // Ø«Ø§Ù„Ø«Ø§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº
    const { data: remainingRecords, error: checkError } = await supabase
      .from('temporary_passwords')
      .select('*');
    
    if (checkError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:', checkError);
      return;
    }
    
    console.log(`ðŸ” Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${remainingRecords?.length || 0}`);
    
    if (remainingRecords && remainingRecords.length === 0) {
      console.log('ðŸŽ‰ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©');
    } else {
      console.log('âš ï¸ Ù…Ø§ Ø²Ø§Ù„Øª Ù‡Ù†Ø§Ùƒ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ¨Ù‚ÙŠØ©:', remainingRecords);
    }
    
  } catch (error) {
    console.error('ðŸ’¥ Ø®Ø·Ø£ Ø¹Ø§Ù…:', error);
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠÙ¾Øª
clearTemporaryPasswords()
  .then(() => {
    console.log('ðŸ Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ');
    process.exit(0);
  })
  .catch((error) => {
    console.error('ðŸ’¥ Ø®Ø·Ø£ Ù†Ù‡Ø§Ø¦ÙŠ:', error);
    process.exit(1);
  });
