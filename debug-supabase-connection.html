<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุดุฎูุต ูุดููุฉ ุงุชุตุงู Supabase</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error-box {
            background: #fee;
            border: 1px solid #fcc;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
            direction: ltr;
            text-align: left;
            font-size: 12px;
        }
        .solution {
            background: #efe;
            border: 1px solid #cfc;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .test-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>๐ง ุชุดุฎูุต ูุดููุฉ ุงุชุตุงู Supabase</h1>
        
        <div class="error-box">
            <strong>ุงูุฎุทุฃ ุงููุจูุบ ุนูู:</strong><br>
            POST https://sbtzngewizgeqzfbhfjy.supabase.co/auth/v1/token?grant_type=refresh_token net::ERR_CONNECTION_CLOSED<br><br>
            TypeError: Failed to fetch<br>
            at _refreshAccessToken (supabase-js.js:6489:20)<br>
            at _callRefreshToken (supabase-js.js:6584:42)
        </div>

        <h2>๐ ุชุดุฎูุต ุงููุดููุฉ</h2>
        
        <div class="warning">
            <strong>โ๏ธ ููุน ุงููุดููุฉ:</strong><br>
            ุฎุทุฃ ูู ุงูุงุชุตุงู ูุน ุฎุงุฏู Supabase ุฃุซูุงุก ุชุฌุฏูุฏ ุฑูุฒ ุงููุตุงุฏูุฉ (refresh token)
        </div>

        <h3>๐ ุงูุฃุณุจุงุจ ุงููุญุชููุฉ</h3>
        
        <div class="step">
            <strong>1. ูุดุงูู ุงูุดุจูุฉ:</strong>
            <ul>
                <li>ุงููุทุงุน ูุคูุช ูู ุงูุฅูุชุฑูุช</li>
                <li>ูุดุงูู ูู DNS</li>
                <li>ุญุฌุจ ูู ุฌุฏุงุฑ ุงูุญูุงูุฉ</li>
                <li>ูุดุงูู ูู ISP</li>
            </ul>
        </div>

        <div class="step">
            <strong>2. ูุดุงูู Supabase:</strong>
            <ul>
                <li>ุงูุชูุงุก ุตูุงุญูุฉ refresh token</li>
                <li>ูุดุงูู ูู ุฎุงุฏู Supabase</li>
                <li>ุชุญุฏูุซุงุช ูู API</li>
                <li>ูุดุงูู ูู ุฅุนุฏุงุฏุงุช ุงููุดุฑูุน</li>
            </ul>
        </div>

        <div class="step">
            <strong>3. ูุดุงูู ุงููุชุตูุญ:</strong>
            <ul>
                <li>ูุดุงูู ูู CORS</li>
                <li>ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช</li>
                <li>ุฅุถุงูุงุช ุงููุชุตูุญ</li>
                <li>ุฅุนุฏุงุฏุงุช ุงูุฃูุงู</li>
            </ul>
        </div>

        <h2>๐งช ุงุฎุชุจุงุฑุงุช ุงูุชุดุฎูุต</h2>

        <div class="step">
            <strong>1. ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจู Supabase:</strong>
            <button onclick="testSupabaseConnection()">ุงุฎุชุจุงุฑ ุงูุงุชุตุงู</button>
            <div id="connectionTest" class="test-result"></div>
        </div>

        <div class="step">
            <strong>2. ุงุฎุชุจุงุฑ DNS:</strong>
            <button onclick="testDNS()">ุงุฎุชุจุงุฑ DNS</button>
            <div id="dnsTest" class="test-result"></div>
        </div>

        <div class="step">
            <strong>3. ูุญุต ุญุงูุฉ Supabase:</strong>
            <button onclick="checkSupabaseStatus()">ูุญุต ุงูุญุงูุฉ</button>
            <div id="statusTest" class="test-result"></div>
        </div>

        <h2>๐๏ธ ุงูุญููู ุงูููุชุฑุญุฉ</h2>

        <div class="solution">
            <h3>ุงูุญู 1: ุฅุนุงุฏุฉ ุชุนููู ุงููุตุงุฏูุฉ</h3>
            <p>ูุณุญ ุจูุงูุงุช ุงููุตุงุฏูุฉ ุงููุญููุฉ ูุฅุนุงุฏุฉ ุชุณุฌูู ุงูุฏุฎูู:</p>
            <button onclick="showAuthReset()">ุนุฑุถ ุงูุฎุทูุงุช</button>
            <div id="authReset" style="display:none;">
                <ol>
                    <li>ุงูุชุญ ุฃุฏูุงุช ุงููุทูุฑ (F12)</li>
                    <li>ุงุฐูุจ ุฅูู ุชุจููุจ Application/Storage</li>
                    <li>ุงุญุฐู ุฌููุน ุจูุงูุงุช localStorage ุงููุชุนููุฉ ุจู Supabase</li>
                    <li>ุงุญุฐู ุฌููุน ุจูุงูุงุช sessionStorage</li>
                    <li>ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ</li>
                    <li>ุณุฌู ุฏุฎูู ุฌุฏูุฏ</li>
                </ol>
            </div>
        </div>

        <div class="solution">
            <h3>ุงูุญู 2: ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก</h3>
            <p>ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃูุถู ูุฃุฎุทุงุก ุงูุงุชุตุงู:</p>
            <button onclick="showErrorHandling()">ุนุฑุถ ุงูููุฏ</button>
            <div id="errorHandling" style="display:none;">
                <pre style="background:#f8f9fa; padding:10px; border-radius:5px; overflow-x:auto;">
// ูู AuthContext.tsx
const handleSupabaseError = (error: any) => {
  if (error.message?.includes('Failed to fetch') || 
      error.message?.includes('ERR_CONNECTION_CLOSED')) {
    console.warn('๐ ูุดููุฉ ุงุชุตุงู ูุคูุชุฉ ูุน Supabase');
    
    // ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ุจุนุฏ ุชุฃุฎูุฑ
    setTimeout(() => {
      window.location.reload();
    }, 5000);
    
    return;
  }
  
  // ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃุฎุฑู
  console.error('ุฎุทุฃ Supabase:', error);
};

// ุชุญุณูู session management
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'TOKEN_REFRESHED') {
    console.log('โ ุชู ุชุฌุฏูุฏ ุงูุฑูุฒ ุจูุฌุงุญ');
  } else if (event === 'SIGNED_OUT') {
    localStorage.clear();
    sessionStorage.clear();
  }
});
                </pre>
            </div>
        </div>

        <div class="solution">
            <h3>ุงูุญู 3: ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ</h3>
            <p>ุชุทุจูู ูุธุงู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ููุทูุจุงุช ุงููุงุดูุฉ:</p>
            <button onclick="showRetryLogic()">ุนุฑุถ ุงูููุฏ</button>
            <div id="retryLogic" style="display:none;">
                <pre style="background:#f8f9fa; padding:10px; border-radius:5px; overflow-x:auto;">
// ุฏุงูุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
const retrySupabaseRequest = async (requestFn: () => Promise<any>, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await requestFn();
    } catch (error: any) {
      if (i === maxRetries - 1) throw error;
      
      if (error.message?.includes('Failed to fetch') || 
          error.message?.includes('ERR_CONNECTION_CLOSED')) {
        console.warn(`๐ ูุญุงููุฉ ${i + 1}/${maxRetries} ูุดูุชุ ุฅุนุงุฏุฉ ุงููุญุงููุฉ...`);
        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
        continue;
      }
      
      throw error;
    }
  }
};

// ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ
const fetchUserProfile = async () => {
  return retrySupabaseRequest(async () => {
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('id', userId)
      .single();
    
    if (error) throw error;
    return data;
  });
};
                </pre>
            </div>
        </div>

        <div class="solution">
            <h3>ุงูุญู 4: ุชุญุณูู ุฅุนุฏุงุฏุงุช Supabase</h3>
            <p>ุชุญุณูู ุฅุนุฏุงุฏุงุช ุงูุนููู ููุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก:</p>
            <button onclick="showSupabaseConfig()">ุนุฑุถ ุงูููุฏ</button>
            <div id="supabaseConfig" style="display:none;">
                <pre style="background:#f8f9fa; padding:10px; border-radius:5px; overflow-x:auto;">
// ูู lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,
    // ุชุญุณูู ุฅุนุฏุงุฏุงุช ุฅุนุงุฏุฉ ุงููุญุงููุฉ
    retryAttempts: 3,
    // ุชูููู timeout ูููุดู ุงูุณุฑูุน ุนู ูุดุงูู ุงูุงุชุตุงู
    timeout: 10000,
  },
  // ุฅุนุฏุงุฏุงุช ุฅุถุงููุฉ ููุดุจูุฉ
  global: {
    headers: {
      'X-Client-Info': 'rezge-app',
    },
  },
  // ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุดุจูุฉ
  realtime: {
    params: {
      eventsPerSecond: 10,
    },
  },
});

// ูุฑุงูุจ ุญุงูุฉ ุงูุงุชุตุงู
supabase.auth.onAuthStateChange((event, session) => {
  console.log('๐ Auth event:', event);
  
  if (event === 'TOKEN_REFRESHED') {
    console.log('โ ุชู ุชุฌุฏูุฏ ุฑูุฒ ุงููุตุงุฏูุฉ');
  } else if (event === 'SIGNED_OUT') {
    console.log('๐ ุชู ุชุณุฌูู ุงูุฎุฑูุฌ');
    // ุชูุธูู ุงูุจูุงูุงุช ุงููุญููุฉ
    localStorage.removeItem('supabase.auth.token');
    sessionStorage.clear();
  }
});
                </pre>
            </div>
        </div>

        <h2>๐จ ุญููู ุณุฑูุนุฉ</h2>

        <div class="info">
            <h3>ูููุณุชุฎุฏููู:</h3>
            <button onclick="quickUserFix()">ุชุทุจูู ุงูุญู ุงูุณุฑูุน</button>
            <div id="userFix" style="display:none;">
                <ol>
                    <li><strong>ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ</strong> (Ctrl+F5)</li>
                    <li><strong>ุงูุณุญ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช</strong></li>
                    <li><strong>ุฌุฑุจ ูุชุตูุญ ุขุฎุฑ</strong></li>
                    <li><strong>ุชุญูู ูู ุงูุฅูุชุฑูุช</strong></li>
                    <li><strong>ุณุฌู ุฎุฑูุฌ ูุฏุฎูู ูุฑุฉ ุฃุฎุฑู</strong></li>
                </ol>
            </div>
        </div>

        <div class="info">
            <h3>ูููุทูุฑูู:</h3>
            <button onclick="quickDevFix()">ุชุทุจูู ุงูุญู ุงูุชููู</button>
            <div id="devFix" style="display:none;">
                <ol>
                    <li>ุชุญูู ูู ุญุงูุฉ Supabase: <a href="https://status.supabase.com" target="_blank">status.supabase.com</a></li>
                    <li>ุฑุงุฌุน ุฅุนุฏุงุฏุงุช CORS ูู ูุดุฑูุน Supabase</li>
                    <li>ุชุญูู ูู ุตุญุฉ environment variables</li>
                    <li>ุฑุงุฌุน logs ูู Supabase Dashboard</li>
                    <li>ุทุจู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุญุณูุฉ</li>
                </ol>
            </div>
        </div>

        <div class="warning">
            <strong>๐ ููุงุญุธุฉ ูููุฉ:</strong><br>
            ูุฐุง ุงูุฎุทุฃ ุนุงุฏุฉ ูุง ูููู ูุคูุชุงู ููุญู ููุณู. ุฅุฐุง ุงุณุชูุฑุ ูุฏ ุชุญุชุงุฌ ููุฑุงุฌุนุฉ ุฅุนุฏุงุฏุงุช ุงูุดุจูุฉ ุฃู ุงูุงุชุตุงู ุจุฏุนู Supabase.
        </div>
    </div>

    <script>
        function testSupabaseConnection() {
            const result = document.getElementById('connectionTest');
            result.style.display = 'block';
            result.innerHTML = '๐ ุฌุงุฑู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู...';
            
            fetch('https://sbtzngewizgeqzfbhfjy.supabase.co/rest/v1/', {
                method: 'HEAD',
                mode: 'no-cors'
            }).then(() => {
                result.className = 'test-result success';
                result.innerHTML = 'โ ุงูุงุชุตุงู ูุน Supabase ูุนูู ุจุดูู ุทุจูุนู';
            }).catch(error => {
                result.className = 'test-result error';
                result.innerHTML = 'โ ูุดู ุงูุงุชุตุงู ูุน Supabase: ' + error.message;
            });
        }
        
        function testDNS() {
            const result = document.getElementById('dnsTest');
            result.style.display = 'block';
            result.innerHTML = '๐ ุฌุงุฑู ุงุฎุชุจุงุฑ DNS...';
            
            fetch('https://8.8.8.8', { method: 'HEAD', mode: 'no-cors' })
                .then(() => {
                    result.className = 'test-result success';
                    result.innerHTML = 'โ DNS ูุนูู ุจุดูู ุทุจูุนู';
                }).catch(() => {
                    result.className = 'test-result error';
                    result.innerHTML = 'โ ูุดููุฉ ูู DNS ุฃู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช';
                });
        }
        
        function checkSupabaseStatus() {
            const result = document.getElementById('statusTest');
            result.style.display = 'block';
            result.innerHTML = '๐ ุฌุงุฑู ูุญุต ุญุงูุฉ Supabase...';
            
            result.className = 'test-result';
            result.innerHTML = '๐ ุชุญูู ูู ุญุงูุฉ Supabase ุนูู: <a href="https://status.supabase.com" target="_blank">status.supabase.com</a>';
        }
        
        function showAuthReset() {
            document.getElementById('authReset').style.display = 'block';
        }
        
        function showErrorHandling() {
            document.getElementById('errorHandling').style.display = 'block';
        }
        
        function showRetryLogic() {
            document.getElementById('retryLogic').style.display = 'block';
        }
        
        function showSupabaseConfig() {
            document.getElementById('supabaseConfig').style.display = 'block';
        }
        
        function quickUserFix() {
            document.getElementById('userFix').style.display = 'block';
        }
        
        function quickDevFix() {
            document.getElementById('devFix').style.display = 'block';
        }
    </script>
</body>
</html>
