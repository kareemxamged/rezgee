/**
 * Ø³ÙƒØ±ÙŠØ¨Øª Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ "alrrakb@hotmail.com" ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
 * ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: 09-08-2025
 * Ø§Ù„ØºØ±Ø¶: Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡
 */

import {
    createClient
} from '@supabase/supabase-js';

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
const supabaseUrl = 'https://sbtzngewizgeqzfbhfjy.supabase.co';
const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNidHpuZ2V3aXpnZXF6ZmJoZmp5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTEzNzkxMywiZXhwIjoyMDY2NzEzOTEzfQ.HhFFZyYcaYlrsllR5VZ0ppix8lOYGsso5IWCPsjP-3g';

// Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase Ù…Ø¹ Service Role Key
const supabase = createClient(supabaseUrl, supabaseServiceKey, {
    auth: {
        autoRefreshToken: false,
        persistSession: false
    }
});

const TARGET_EMAIL = 'alrrakb@hotmail.com';

/**
 * Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 */
async function findUserByEmail(email) {
    try {
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${email}`);

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ø¯ÙˆÙ„ users
        const {
            data: users,
            error: usersError
        } = await supabase
            .from('users')
            .select('id, email, first_name, last_name, status, created_at')
            .eq('email', email.toLowerCase())
            .limit(1);

        if (usersError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ø¯ÙˆÙ„ users:', usersError.message);
            return null;
        }

        if (users && users.length > 0) {
            const user = users[0];
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ users:`);
            console.log(`   - Ø§Ù„Ù…Ø¹Ø±Ù: ${user.id}`);
            console.log(`   - Ø§Ù„Ø§Ø³Ù…: ${user.first_name} ${user.last_name}`);
            console.log(`   - Ø§Ù„Ø­Ø§Ù„Ø©: ${user.status}`);
            console.log(`   - ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${user.created_at}`);
            return user;
        }

        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ users');
        return null;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error.message);
        return null;
    }
}

/**
 * Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ auth.users
 */
async function deleteUserFromAuth(userId) {
    try {
        console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† auth.users: ${userId}`);

        const {
            error
        } = await supabase.auth.admin.deleteUser(userId);

        if (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† auth.users:', error.message);
            return false;
        }

        console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† auth.users Ø¨Ù†Ø¬Ø§Ø­');
        return true;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† auth.users:', error.message);
        return false;
    }
}

/**
 * Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users (soft delete)
 */
async function deleteUserFromUsersTable(userId) {
    try {
        console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users: ${userId}`);

        const {
            error
        } = await supabase
            .from('users')
            .update({
                status: 'deleted',
                deleted_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .eq('id', userId);

        if (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users:', error.message);
            return false;
        }

        console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users Ø¨Ù†Ø¬Ø§Ø­');
        return true;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users:', error.message);
        return false;
    }
}

/**
 * Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
 */
async function deleteAllPendingVerifications() {
    try {
        console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...');

        // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        const {
            data: emailVerifications,
            error: emailError
        } = await supabase
            .from('email_verifications')
            .delete()
            .eq('status', 'pending')
            .select();

        if (emailError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:', emailError.message);
        } else {
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${emailVerifications?.length || 0} Ø·Ù„Ø¨ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ`);
        }

        // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        const {
            data: verificationRequests,
            error: verificationError
        } = await supabase
            .from('verification_requests')
            .delete()
            .in('status', ['pending', 'under_review'])
            .select();

        if (verificationError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚:', verificationError.message);
        } else {
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${verificationRequests?.length || 0} Ø·Ù„Ø¨ ØªÙˆØ«ÙŠÙ‚`);
        }

        // Ø­Ø°Ù ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
        const {
            data: tempPasswords,
            error: tempPasswordError
        } = await supabase
            .from('temporary_passwords')
            .delete()
            .eq('is_used', false)
            .select();

        if (tempPasswordError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©:', tempPasswordError.message);
        } else {
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${tempPasswords?.length || 0} ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©`);
        }

        // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        const {
            data: passwordResets,
            error: passwordResetError
        } = await supabase
            .from('password_reset_requests')
            .delete()
            .eq('status', 'pending')
            .select();

        if (passwordResetError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', passwordResetError.message);
        } else {
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${passwordResets?.length || 0} Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±`);
        }

        return true;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:', error.message);
        return false;
    }
}

/**
 * Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
async function deleteUserRelatedData(userId) {
    try {
        console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`);

        // Ø­Ø°Ù ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        const {
            error: tempPasswordError
        } = await supabase
            .from('temporary_passwords')
            .delete()
            .eq('user_id', userId);

        if (tempPasswordError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©:', tempPasswordError.message);
        } else {
            console.log('âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
        }

        // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const {
            error: passwordResetError
        } = await supabase
            .from('password_reset_requests')
            .delete()
            .eq('user_id', userId);

        if (passwordResetError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', passwordResetError.message);
        } else {
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        }

        // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚
        const {
            error: verificationError
        } = await supabase
            .from('verification_requests')
            .delete()
            .eq('user_id', userId);

        if (verificationError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚:', verificationError.message);
        } else {
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØ«ÙŠÙ‚');
        }

        // Ø­Ø°Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ«Ù‚Ø©
        const {
            error: trustedDevicesError
        } = await supabase
            .from('user_trusted_devices')
            .delete()
            .eq('user_id', userId);

        if (trustedDevicesError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ«Ù‚Ø©:', trustedDevicesError.message);
        } else {
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ«Ù‚Ø©');
        }

        // Ø­Ø°Ù Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚
        const {
            error: verificationCodesError
        } = await supabase
            .from('user_verification_codes')
            .delete()
            .eq('user_id', userId);

        if (verificationCodesError) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚:', verificationCodesError.message);
        } else {
            console.log('âœ… ØªÙ… Ø­Ø°Ù Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚');
        }

        return true;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©:', error.message);
        return false;
    }
}

/**
 * Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
 */
async function main() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©...');
    console.log(`ğŸ“§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ${TARGET_EMAIL}`);
    console.log('='.repeat(60));

    try {
        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const user = await findUserByEmail(TARGET_EMAIL);

        if (!user) {
            console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙ‚Ø·...');
        } else {
            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù...');

            // 2. Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            await deleteUserRelatedData(user.id);

            // 3. Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users
            await deleteUserFromUsersTable(user.id);

            // 4. Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† auth.users
            await deleteUserFromAuth(user.id);
        }

        // 5. Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        await deleteAllPendingVerifications();

        console.log('='.repeat(60));
        console.log('âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­!');
        console.log('ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', error.message);
        process.exit(1);
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
main().catch(console.error);

export {
    findUserByEmail,
    deleteUserFromAuth,
    deleteUserFromUsersTable,
    deleteAllPendingVerifications,
    deleteUserRelatedData
};