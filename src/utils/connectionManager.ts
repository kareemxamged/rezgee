/**
 * ูุฏูุฑ ุงูุงุชุตุงู ูุน Supabase
 * ูุชุนุงูู ูุน ุฃุฎุทุงุก ุงูุดุจูุฉ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ
 */

import React from 'react';
import { supabase, retrySupabaseRequest, handleSupabaseError } from '../lib/supabase';

export interface ConnectionStatus {
  isOnline: boolean;
  isSupabaseReachable: boolean;
  lastChecked: Date;
  errorCount: number;
  isRecovering: boolean;
  autoRetryEnabled: boolean;
  lastSuccessfulConnection: Date;
}

class ConnectionManager {
  private status: ConnectionStatus = {
    isOnline: navigator.onLine,
    isSupabaseReachable: true,
    lastChecked: new Date(),
    errorCount: 0,
    isRecovering: false,
    autoRetryEnabled: true,
    lastSuccessfulConnection: new Date()
  };

  private listeners: ((status: ConnectionStatus) => void)[] = [];
  private checkInterval: NodeJS.Timeout | null = null;
  private retryTimeout: NodeJS.Timeout | null = null;
  private retryAttempts = 0;
  private maxRetryAttempts = 10; // ุฒูุงุฏุฉ ุนุฏุฏ ุงููุญุงููุงุช
  private silentMode = true; // ุชูุนูู ุงููุถุน ุงูุตุงูุช ุงูุชุฑุงุถูุงู

  constructor() {
    this.setupEventListeners();
    this.startPeriodicCheck();
  }

  /**
   * ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
   */
  private setupEventListeners() {
    // ูุฑุงูุจุฉ ุญุงูุฉ ุงูุฅูุชุฑูุช
    window.addEventListener('online', () => {
      this.updateStatus({ isOnline: true });
      this.checkSupabaseConnection();
    });

    window.addEventListener('offline', () => {
      this.updateStatus({ isOnline: false, isSupabaseReachable: false });
    });

    // ูุฑุงูุจุฉ ุฃุฎุทุงุก Supabase
    window.addEventListener('supabase-connection-error', (event: any) => {
      this.handleConnectionError(event.detail);
    });
  }

  /**
   * ุจุฏุก ุงููุญุต ุงูุฏูุฑู ููุงุชุตุงู
   */
  private startPeriodicCheck() {
    this.checkInterval = setInterval(() => {
      if (this.status.isOnline) {
        this.checkSupabaseConnection();
      }
    }, 30000); // ูุญุต ูู 30 ุซุงููุฉ
  }

  /**
   * ูุญุต ุงูุงุชุตุงู ูุน Supabase
   */
  private async checkSupabaseConnection(): Promise<boolean> {
    try {
      // ูุญุงููุฉ ุทูุจ ุจุณูุท ููุชุญูู ูู ุงูุงุชุตุงู ูุน timeout
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Connection timeout')), 10000);
      });

      const connectionPromise = supabase
        .from('users')
        .select('id')
        .limit(1);

      const { error } = await Promise.race([connectionPromise, timeoutPromise]) as any;

      const isReachable = !error || !this.isConnectionError(error);

      if (isReachable) {
        this.resetRetryState();
        this.updateStatus({
          isSupabaseReachable: true,
          lastChecked: new Date(),
          errorCount: 0,
          lastSuccessfulConnection: new Date()
        });
      } else {
        this.updateStatus({
          isSupabaseReachable: false,
          lastChecked: new Date(),
          errorCount: this.status.errorCount + 1
        });
      }

      return isReachable;
    } catch (error) {
      this.updateStatus({
        isSupabaseReachable: false,
        lastChecked: new Date(),
        errorCount: this.status.errorCount + 1
      });

      return false;
    }
  }

  /**
   * ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุงุชุตุงู
   */
  private handleConnectionError(detail: { error: any; context?: string }) {
    const { error, context } = detail;

    this.updateStatus({
      isSupabaseReachable: false,
      errorCount: this.status.errorCount + 1
    });

    // ุจุฏุก ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ
    this.startAutoRetry();

    handleSupabaseError(error, context);
  }

  /**
   * ุจุฏุก ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ (ุจุตูุช)
   */
  private startAutoRetry() {
    if (!this.status.autoRetryEnabled || this.status.isRecovering) {
      return;
    }

    if (this.retryAttempts >= this.maxRetryAttempts) {
      // ูู ุงููุถุน ุงูุตุงูุชุ ูุณุชูุฑ ูู ุงููุญุงููุฉ ุจูุชุฑุงุช ุฃุทูู
      if (this.silentMode) {
        this.startLongTermRetry();
        return;
      }
      console.warn('๐ ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ูุญุงููุงุช ุฅุนุงุฏุฉ ุงูุงุชุตุงู');
      this.suggestSolutions();
      return;
    }

    this.updateStatus({ isRecovering: true });
    this.retryAttempts++;

    // ุญุณุงุจ ุงูุชุฃุฎูุฑ ูุน Exponential Backoff (ุฃุณุฑุน ูู ุงูุจุฏุงูุฉ)
    const delay = Math.min(500 * Math.pow(1.5, this.retryAttempts - 1), 10000); // ุญุฏ ุฃูุตู 10 ุซูุงูู

    if (!this.silentMode) {
      console.log(`๐ ูุญุงููุฉ ุฅุนุงุฏุฉ ุงูุงุชุตุงู ${this.retryAttempts}/${this.maxRetryAttempts} ุฎูุงู ${delay}ms`);
    }

    this.retryTimeout = setTimeout(async () => {
      try {
        const isConnected = await this.checkSupabaseConnection();
        if (isConnected) {
          console.log('โ ุชู ุงุณุชุนุงุฏุฉ ุงูุงุชุตุงู ุจูุฌุงุญ');
          this.resetRetryState();
          this.updateStatus({
            lastSuccessfulConnection: new Date(),
            isRecovering: false
          });
        } else {
          // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
          this.updateStatus({ isRecovering: false });
          this.startAutoRetry();
        }
      } catch (error) {
        console.error('ูุดู ูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ:', error);
        this.updateStatus({ isRecovering: false });
        this.startAutoRetry();
      }
    }, delay);
  }

  /**
   * ุจุฏุก ูุญุงููุงุช ุทูููุฉ ุงููุฏู (ูู ุฏูููุฉ)
   */
  private startLongTermRetry() {
    if (this.retryTimeout) {
      clearTimeout(this.retryTimeout);
    }

    this.retryTimeout = setTimeout(async () => {
      const isConnected = await this.checkConnection();
      if (!isConnected) {
        this.startLongTermRetry(); // ุงุณุชูุฑุงุฑ ุงููุญุงููุฉ
      }
    }, 60000); // ูุญุงููุฉ ูู ุฏูููุฉ
  }

  /**
   * ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ
   */
  private resetRetryState() {
    this.retryAttempts = 0;
    if (this.retryTimeout) {
      clearTimeout(this.retryTimeout);
      this.retryTimeout = null;
    }
  }

  /**
   * ุงูุชุฑุงุญ ุญููู ูููุณุชุฎุฏู (ููุท ูู ุงููุถุน ุบูุฑ ุงูุตุงูุช)
   */
  private suggestSolutions() {
    // ูู ุงููุถุน ุงูุตุงูุชุ ูุง ูุนุฑุถ ุฃู ุฑุณุงุฆู ูููุณุชุฎุฏู
    if (this.silentMode) {
      console.log('๐ ุงูุงุชุตุงู ูููุทุนุ ุณูุชู ุงููุญุงููุฉ ุชููุงุฆูุงู ูู ุงูุฎูููุฉ');
      this.startLongTermRetry();
      return;
    }

    const solutions = [
      'ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช',
      'ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ',
      'ุงูุณุญ ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช',
      'ุฌุฑุจ ูุชุตูุญ ุขุฎุฑ'
    ];

    console.warn('๐ง ุงูุชุฑุงุญุงุช ูุญู ูุดููุฉ ุงูุงุชุตุงู:', solutions);

    // ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุงุฌูุฉ (ููุท ูู ุงููุถุน ุบูุฑ ุงูุตุงูุช)
    const event = new CustomEvent('connection-solutions', {
      detail: { solutions, errorCount: this.status.errorCount, autoRetryFailed: true }
    });
    window.dispatchEvent(event);
  }

  /**
   * ุชุญุฏูุซ ุญุงูุฉ ุงูุงุชุตุงู
   */
  private updateStatus(updates: Partial<ConnectionStatus>) {
    this.status = { ...this.status, ...updates };
    this.notifyListeners();
  }

  /**
   * ุฅุดุนุงุฑ ุงููุณุชูุนูู ุจุชุบููุฑ ุงูุญุงูุฉ
   */
  private notifyListeners() {
    this.listeners.forEach(listener => listener(this.status));
  }

  /**
   * ูุญุต ูุง ุฅุฐุง ูุงู ุงูุฎุทุฃ ูุชุนูู ุจุงูุงุชุตุงู
   */
  private isConnectionError(error: any): boolean {
    const errorMessage = error?.message || '';
    return errorMessage.includes('Failed to fetch') ||
           errorMessage.includes('ERR_CONNECTION_CLOSED') ||
           errorMessage.includes('NetworkError') ||
           error?.name === 'AbortError';
  }

  /**
   * ุฅุถุงูุฉ ูุณุชูุน ูุชุบููุฑุงุช ุญุงูุฉ ุงูุงุชุตุงู
   */
  public addStatusListener(listener: (status: ConnectionStatus) => void) {
    this.listeners.push(listener);
    // ุฅุฑุณุงู ุงูุญุงูุฉ ุงูุญุงููุฉ ููุฑุงู
    listener(this.status);
  }

  /**
   * ุฅุฒุงูุฉ ูุณุชูุน
   */
  public removeStatusListener(listener: (status: ConnectionStatus) => void) {
    const index = this.listeners.indexOf(listener);
    if (index > -1) {
      this.listeners.splice(index, 1);
    }
  }

  /**
   * ุชูุนูู/ุฅูุบุงุก ุงููุถุน ุงูุตุงูุช
   */
  public setSilentMode(silent: boolean) {
    this.silentMode = silent;
    console.log(`๐ ุงููุถุน ุงูุตุงูุช: ${silent ? 'ููุนู' : 'ูุนุทู'}`);
  }

  /**
   * ุงูุญุตูู ุนูู ุญุงูุฉ ุงููุถุน ุงูุตุงูุช
   */
  public isSilentMode(): boolean {
    return this.silentMode;
  }

  /**
   * ุงูุญุตูู ุนูู ุญุงูุฉ ุงูุงุชุตุงู ุงูุญุงููุฉ
   */
  public getStatus(): ConnectionStatus {
    return { ...this.status };
  }

  /**
   * ูุญุต ุงูุงุชุตุงู ูุฏููุงู
   */
  public async checkConnection(): Promise<boolean> {
    return this.checkSupabaseConnection();
  }

  /**
   * ุฅุนุงุฏุฉ ุชุนููู ุนุฏุงุฏ ุงูุฃุฎุทุงุก
   */
  public resetErrorCount() {
    this.updateStatus({ errorCount: 0 });
  }

  /**
   * ุชูุธูู ุงูููุงุฑุฏ
   */
  public cleanup() {
    if (this.checkInterval) {
      clearInterval(this.checkInterval);
      this.checkInterval = null;
    }
    this.listeners = [];
  }
}

// ุฅูุดุงุก ูุซูู ูุงุญุฏ ูู ูุฏูุฑ ุงูุงุชุตุงู
export const connectionManager = new ConnectionManager();

/**
 * Hook ูุงุณุชุฎุฏุงู ุญุงูุฉ ุงูุงุชุตุงู ูู React
 */
export const useConnectionStatus = () => {
  const [status, setStatus] = React.useState<ConnectionStatus>(
    connectionManager.getStatus()
  );

  React.useEffect(() => {
    connectionManager.addStatusListener(setStatus);
    
    return () => {
      connectionManager.removeStatusListener(setStatus);
    };
  }, []);

  return status;
};

/**
 * ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชูููุฐ ุทูุจุงุช Supabase ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
 */
export const executeSupabaseRequest = async <T>(
  requestFn: () => Promise<T>,
  context?: string,
  maxRetries = 3
): Promise<T> => {
  try {
    return await retrySupabaseRequest(requestFn, maxRetries);
  } catch (error) {
    handleSupabaseError(error, context);
    throw error;
  }
};

/**
 * ุฏุงูุฉ ููุชุญูู ูู ุตุญุฉ ุงูุงุชุตุงู ูุจู ุชูููุฐ ุทูุจ ููู
 */
export const ensureConnection = async (): Promise<boolean> => {
  const status = connectionManager.getStatus();
  
  if (!status.isOnline) {
    throw new Error('ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุฅูุชุฑูุช');
  }
  
  if (!status.isSupabaseReachable) {
    const isReachable = await connectionManager.checkConnection();
    if (!isReachable) {
      throw new Error('ูุง ูููู ุงููุตูู ุฅูู ุฎุงุฏู ุงูุจูุงูุงุช');
    }
  }
  
  return true;
};

export default connectionManager;
